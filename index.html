<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Suite CSV ‚Äî Chart.js + JS (GitHub Pages)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Librer√≠as: PapaParse (CSV) + Chart.js (gr√°ficos) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-soft:#020617;
      --card:#020617;
      --card-soft:#020617;
      --muted:#94a3b8;
      --border:#1e293b;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.13);
      --danger:#ef4444;
      --danger-soft:rgba(239,68,68,0.13);
      --shadow-soft:0 18px 35px rgba(15,23,42,0.85);
      --shadow-subtle:0 10px 30px rgba(15,23,42,0.7);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(circle at 0 0, #0f172a 0, #020617 55%),
        radial-gradient(circle at 100% 0, #111827 0, #020617 55%),
        radial-gradient(circle at 0 100%, #020617 0, #000 55%);
      color:var(--text);
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
    }

    h1{
      font-size:1.3rem;
      letter-spacing:0.03em;
      text-transform:uppercase;
      color:#e5e7eb;
      margin-bottom:4px;
      text-align:center;
    }
    .subtitle{
      text-align:center;
      font-size:0.85rem;
      color:var(--muted);
      margin-bottom:16px;
    }

    .grid{
      display:grid;
      grid-template-columns:1.1fr 1.1fr;
      gap:12px;
      align-items:flex-start;
    }

    .card{
      background:radial-gradient(circle at 0 0, #020617 0, #020617 60%);
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.18);
      box-shadow:var(--shadow-soft);
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(circle at 0 0, rgba(56,189,248,0.08), transparent 50%),
        radial-gradient(circle at 100% 0, rgba(34,197,94,0.08), transparent 50%);
      opacity:0.75;
      pointer-events:none;
      z-index:-1;
    }

    .card h2{
      font-size:0.78rem;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .badge{
      font-size:0.72rem;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(148,163,184,0.45);
      color:#e5e7eb;
    }
    .card-section{
      font-size:0.8rem;
      color:var(--muted);
      margin-bottom:8px;
    }

    label{
      font-size:0.75rem;
      color:var(--muted);
      display:block;
      margin-bottom:3px;
    }

    select,input[type="text"],input[type="number"]{
      width:100%;
      padding:5px 7px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,0.3);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:0.78rem;
      outline:none;
    }

    button{
      padding:6px 10px;
      border-radius:999px;
      border:none;
      font-size:0.78rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:5px;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#22c55e,#22d3ee);
      color:#0f172a;
      box-shadow:0 8px 20px rgba(34,197,94,0.45);
    }
    .btn-ghost{
      background:rgba(15,23,42,0.85);
      color:var(--muted);
      border:1px solid rgba(148,163,184,0.35);
    }
    .btn-link{
      background:transparent;
      color:var(--muted);
      padding:0;
      border-radius:0;
      box-shadow:none;
    }

    .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .col{
      flex:1;
      min-width:0;
    }
    .col-2{
      flex:2;
    }
    .col-fixed{
      flex:0 0 auto;
    }

    .hint{
      font-size:0.72rem;
      color:var(--muted);
      margin-top:2px;
    }

    .pill{
      padding:4px 9px;
      border-radius:999px;
      font-size:0.72rem;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.95);
      color:var(--text);
      cursor:pointer;
    }

    .alert{
      border-radius:10px;
      padding:6px 8px;
      font-size:0.76rem;
      margin-top:4px;
    }
    .alert-info{
      background:rgba(56,189,248,0.06);
      border:1px solid rgba(56,189,248,0.4);
      color:#e0f2fe;
    }
    .alert-error{
      background:var(--danger-soft);
      border:1px solid var(--danger);
      color:#fee2e2;
    }
    .alert-ok{
      background:var(--accent-soft);
      border:1px solid var(--accent);
      color:#dcfce7;
    }

    .log{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:0.72rem;
      white-space:pre-wrap;
      max-height:130px;
      overflow:auto;
      background:rgba(15,23,42,0.85);
      border-radius:10px;
      padding:7px;
      border:1px solid rgba(148,163,184,0.35);
    }

    #dfPreview{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:0.75rem;
      max-height:260px;
      overflow:auto;
      margin-top:8px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.85);
    }
    #dfPreview table{
      border-collapse:collapse;
      width:100%;
      min-width:400px;
    }
    #dfPreview th,#dfPreview td{
      border:1px solid rgba(51,65,85,0.7);
      padding:3px 5px;
      text-align:left;
    }
    #dfPreview th{
      background:rgba(15,23,42,0.95);
      position:sticky;
      top:0;
      z-index:1;
    }
    #dfPreview tbody tr:nth-child(even){
      background:rgba(15,23,42,0.85);
    }

    #chartCanvas{
      width:100% !important;
      height:380px !important;
    }

    .chart-container{
      position:relative;
      width:100%;
      height:380px;
      margin-top:8px;
    }

    .code{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      font-size:0.75rem;
      background:rgba(15,23,42,0.85);
      padding:4px 6px;
      border-radius:6px;
      border:1px solid rgba(148,163,184,0.4);
    }

    .tag{
      font-size:0.7rem;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      color:var(--muted);
    }

    .footer-note{
      text-align:center;
      font-size:0.7rem;
      color:var(--muted);
      margin-top:8px;
    }

    @media(max-width:1024px){
      .grid{
        grid-template-columns:1fr;
      }
      .card{
        box-shadow:var(--shadow-subtle);
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Suite CSV ‚Äî Chart.js + JS</h1>
  <div class="subtitle">
    Carga un <span class="code">.csv</span>, genera estad√≠sticas, gr√°ficos, stack y split sobre columnas num√©ricas/categ√≥ricas.
  </div>

  <!-- ================= PRIMERA FILA: CARGA / STATS ================= -->
  <div class="grid" style="margin-bottom:10px;">
    <!-- CARGA CSV -->
    <div class="card">
      <h2>
        1. Cargar CSV
        <span class="badge">Base</span>
      </h2>
      <div class="card-section">
        Sube un archivo <span class="code">.csv</span> (separado por coma) para crear <span class="code">df_work</span>.
      </div>

      <div class="row">
        <div class="col">
          <label for="csvInput">Archivo CSV</label>
          <input type="file" id="csvInput" accept=".csv,text/csv" />
          <div class="hint">Se usar√° la primera fila como encabezados.</div>
        </div>
        <div class="col-fixed">
          <button class="btn-primary" id="btnLoadCsv">
            üöÄ Cargar en df_work
          </button>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div id="loadStatus" class="hint">A√∫n no se ha cargado ning√∫n CSV.</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Columnas detectadas</label>
          <div id="columnsList" class="hint">(vac√≠o)</div>
        </div>
      </div>
    </div>

    <!-- STATS -->
    <div class="card">
      <h2>
        2. Stats r√°pidas
        <span class="badge">Describe</span>
      </h2>
      <div class="card-section">
        Calcula conteos, media, min, max de una columna num√©rica (o mezcla num√©rica/categ√≥rica simple).
      </div>

      <div class="row">
        <div class="col">
          <label for="statsCol">Columna para stats</label>
          <select id="statsCol"></select>
        </div>
        <div class="col-fixed">
          <button class="btn-primary" id="btnStats">üìä Calcular</button>
        </div>
      </div>

      <div id="statsResult" class="log"></div>
    </div>
  </div>

  <!-- =============== SEGUNDO BLOQUE: CHART A TODO EL ANCHO =============== -->
  <div class="card" style="margin-bottom:10px;">
    <h2>
      3. Chart (X vs m√∫ltiples Y)
      <span class="badge">Chart.js</span>
    </h2>
    <div class="card-section">
      Genera un gr√°fico (l√≠nea/barras) con una columna <span class="code">X</span> y varias columnas <span class="code">Y</span> simult√°neas.
    </div>

    <div class="row">
      <div class="col">
        <label for="chartX">Columna X</label>
        <select id="chartX"></select>
      </div>
      <div class="col">
        <label for="chartY">Columnas Y (una o varias)</label>
        <select id="chartY" multiple size="5"></select>
        <div class="hint">Puedes seleccionar m√°s de una columna (Ctrl/Cmd + clic).</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="chartType">Tipo de gr√°fico</label>
        <select id="chartType">
          <option value="line">L√≠nea</option>
          <option value="bar">Barras</option>
        </select>
      </div>
      <div class="col-fixed">
        <button class="btn-primary" id="btnChart">üìà Dibujar</button>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="chartCanvas"></canvas>
    </div>
  </div>

  <!-- ================= TERCERA FILA: STACK / SPLIT / EXPORT ================= -->
  <div class="grid">
    <!-- STACK -->
    <div class="card">
      <h2>
        4. Stack (reordenar columnas y crear √≠ndices)
        <span class="badge">Transform</span>
      </h2>
      <div class="card-section">
        Crea nuevas columnas de √≠ndice y reordena seg√∫n tus necesidades sin perder filas.
      </div>

      <div class="row">
        <div class="col">
          <label for="stackIndexCols">Columnas √≠ndice (elige una o varias)</label>
          <select id="stackIndexCols" multiple size="6"></select>
          <div class="hint">Se crear√°n columnas √≠ndice <span class="code">idx_1, idx_2‚Ä¶</span> con estas columnas.</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="stackOrderCols">Nuevo orden de columnas (elige una o varias)</label>
          <select id="stackOrderCols" multiple size="6"></select>
          <div class="hint">Las seleccionadas ir√°n primero en ese orden; las dem√°s se agregan al final.</div>
        </div>
      </div>

      <div class="row">
        <div class="col-fixed">
          <button class="btn-primary" id="btnStack">üß± Hacer Stack</button>
        </div>
        <div class="col">
          <span class="hint">Crea <span class="code">df_work</span> modificado (no destruye el archivo original cargado).</span>
        </div>
      </div>

      <div id="stackStatus" class="log"></div>
    </div>

    <!-- SPLIT -->
    <div class="card">
      <h2>
        5. Split por valores
        <span class="badge">Grupos</span>
      </h2>
      <div class="card-section">
        Informa y permite filtrar <span class="code">df_work</span> por un valor de columna base. Luego puedes exportar el subset.
      </div>

      <div class="row">
        <div class="col">
          <label for="splitBaseCol">Columna base (categor√≠a / grupo)</label>
          <select id="splitBaseCol"></select>
          <div class="hint">Se detectar√°n valores √∫nicos en esta columna.</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="splitViewCol">Columna para vista r√°pida (opcional)</label>
          <select id="splitViewCol"></select>
          <div class="hint">Si se selecciona, la vista previa mostrar√° solo base + vista. Si no, se muestran todas.</div>
        </div>
      </div>

      <div class="row">
        <div class="col-fixed">
          <button class="btn-primary" id="btnSplit">‚úÇÔ∏è Hacer Split</button>
        </div>
        <div class="col">
          <span class="hint">Luego puedes hacer <b>Exportar CSV</b> sobre el subset filtrado.</span>
        </div>
      </div>

      <div id="splitStatus" class="log"></div>
      <div id="splitPreview" class="log" style="max-height:260px;"></div>
    </div>

    <!-- EXPORT / RESET -->
    <div class="card">
      <h2>
        6. Exportar / Reset
        <span class="badge">Salida</span>
      </h2>
      <div class="card-section">
        Descarga el <span class="code">df_work</span> actual como CSV o vuelve al estado inicial (sin datos).
      </div>

      <div class="row">
        <div class="col-fixed">
          <button class="btn-primary" id="btnExportCsv">üíæ Exportar df_work.csv</button>
        </div>
        <div class="col-fixed">
          <button class="btn-ghost" id="btnReset">üßπ Reset Base</button>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div id="exportStatus" class="hint">df_work actual: (vac√≠o)</div>
        </div>
      </div>

      <div id="dfPreview"></div>
    </div>
  </div>

  <div class="footer-note">
    df_work vive solo en memoria del navegador. No se suben datos a ning√∫n servidor.
  </div>
</div>

<script>
  let dfWork = [];
  let columns = [];
  let originalDf = [];

  let chartInstance = null;

  function showMessage(type, html){
    const loadStatus = document.getElementById("loadStatus");
    const exportStatus = document.getElementById("exportStatus");

    const box = document.createElement("div");
    box.className = "alert " + (
      type==="error" ? "alert-error" :
      type==="ok"    ? "alert-ok" :
                       "alert-info"
    );
    box.innerHTML = html;

    loadStatus.innerHTML = "";
    exportStatus.innerHTML = "";
    loadStatus.appendChild(box.cloneNode(true));
    exportStatus.appendChild(box);
  }

  function dfToHtmlPreview(df, maxRows=10){
    if (!df || df.length===0) return "<em>(df vac√≠o)</em>";
    const cols = Object.keys(df[0]);
    let html = "<table><thead><tr>";
    for (let c of cols){
      html += "<th>"+c+"</th>";
    }
    html += "</tr></thead><tbody>";
    for (let i=0; i<Math.min(df.length,maxRows); i++){
      const row = df[i];
      html += "<tr>";
      for (let c of cols){
        let v = row[c];
        if (v===null || v===undefined) v="";
        html += "<td>"+String(v)+"</td>";
      }
      html += "</tr>";
    }
    if (df.length>maxRows){
      html += `<tr><td colspan="${cols.length}">‚Ä¶ (${df.length-maxRows} filas m√°s)</td></tr>`;
    }
    html += "</tbody></table>";
    return html;
  }

  function refreshColumnSelects(){
    const ids = ["statsCol","chartX","chartY","stackIndexCols","stackOrderCols","splitBaseCol","splitViewCol"];
    const selects = ids.map(id => document.getElementById(id)).filter(el => el && el.tagName==="SELECT");

    selects.forEach(sel => {
      while (sel.firstChild) sel.removeChild(sel.firstChild);
    });

    if (!columns || columns.length===0) return;

    selects.forEach(sel => {
      columns.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
    });

    if (columns.length){
      const statsCol = document.getElementById("statsCol");
      if (statsCol) statsCol.value = columns[0];

      const chartX = document.getElementById("chartX");
      if (chartX) chartX.value = columns[0];

      // Multi-select Y: por defecto selecciona 1‚Äì2 columnas
      const chartY = document.getElementById("chartY");
      if (chartY) {
        Array.from(chartY.options).forEach(opt => opt.selected = false);
        if (chartY.options.length > 0) chartY.options[0].selected = true;
        if (chartY.options.length > 1) chartY.options[1].selected = true;
      }

      const splitBase = document.getElementById("splitBaseCol");
      if (splitBase) splitBase.value = columns[0];

      const splitView = document.getElementById("splitViewCol");
      if (splitView && columns.length>1) splitView.value = columns[1];
    }

    const columnsList = document.getElementById("columnsList");
    columnsList.textContent = columns.length
      ? columns.join("  |  ")
      : "(sin columnas)";
  }

  function handleLoadCsv(){
    const input = document.getElementById("csvInput");
    const file = input.files && input.files[0];
    if (!file){
      showMessage("error","Debes seleccionar un archivo .csv.");
      return;
    }

    Papa.parse(file, {
      header:true,
      dynamicTyping:true,
      skipEmptyLines:true,
      complete:function(results){
        dfWork = results.data;
        originalDf = JSON.parse(JSON.stringify(dfWork));
        if (!dfWork.length){
          showMessage("error","El CSV est√° vac√≠o o no se pudieron leer filas.");
          return;
        }
        columns = Object.keys(dfWork[0]);
        refreshColumnSelects();

        document.getElementById("loadStatus").innerHTML =
          `<div class="alert alert-ok">‚úÖ Cargadas <b>${dfWork.length}</b> filas, <b>${columns.length}</b> columnas.</div>`;

        renderDfPreview();
      },
      error:function(err){
        showMessage("error","Error al parsear CSV: "+err.message);
      }
    });
  }

  function renderStats(){
    const colName = document.getElementById("statsCol").value;
    const box = document.getElementById("statsResult");
    box.textContent = "";

    if (!colName || !columns.includes(colName)){
      box.textContent = "Selecciona una columna v√°lida.";
      return;
    }

    const vals = dfWork.map(r => r[colName]).filter(v => v!==null && v!==undefined && v!=="");
    if (!vals.length){
      box.textContent = "Columna sin datos.";
      return;
    }

    const nums = vals.map(v => typeof v==="number" ? v : Number(v)).filter(v => !isNaN(v));
    let txt = `Columna: ${colName}\nFilas no vac√≠as: ${vals.length}\n`;

    if (nums.length){
      const n = nums.length;
      const sum = nums.reduce((a,b)=>a+b,0);
      const mean = sum/n;
      const min = Math.min(...nums);
      const max = Math.max(...nums);
      txt += `Tipo detectado: num√©rico\n`;
      txt += `Valores num√©ricos: ${nums.length}\nMedia: ${mean}\nMin: ${min}\nMax: ${max}\n`;
    } else {
      const counts = {};
      vals.forEach(v => {
        const k = String(v);
        counts[k] = (counts[k]||0)+1;
      });
      txt += "Tipo detectado: categ√≥rico / texto\n";
      txt += "Top categor√≠as:\n";
      const ordered = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
      ordered.forEach(([k,c])=>{
        txt += `  - ${k}: ${c}\n`;
      });
    }

    box.textContent = txt;
  }

  function renderChart(){
    const xCol = document.getElementById("chartX").value;
    const chartYSelect = document.getElementById("chartY");
    const type = document.getElementById("chartType").value;

    if (!xCol || !columns.includes(xCol)){
      showMessage("error","Selecciona una columna X v√°lida.");
      return;
    }

    if (!chartYSelect){
      showMessage("error","No se encontr√≥ el selector de columnas Y.");
      return;
    }

    const yCols = Array.from(chartYSelect.selectedOptions).map(opt => opt.value);
    if (!yCols.length){
      showMessage("error","Selecciona al menos una columna Y.");
      return;
    }

    // Labels X
    const labels = dfWork.map(r => {
      const v = r[xCol];
      return (v===undefined || v===null) ? "" : String(v);
    });

    // Datasets Y m√∫ltiples
    const datasets = yCols.map((yCol) => {
      if (!columns.includes(yCol)) return null;
      const yValues = dfWork.map(r => {
        const v = r[yCol];
        return (typeof v==="number") ? v : Number(v);
      }).map(v => isNaN(v) ? 0 : v);

      return {
        label: yCol,
        data: yValues,
        borderWidth:1.5,
        tension:0.2,
        fill:false
        // Chart.js asigna colores autom√°ticamente
      };
    }).filter(ds => ds!==null);

    if (!datasets.length){
      showMessage("error","Las columnas Y seleccionadas no son v√°lidas.");
      return;
    }

    const ctx = document.getElementById("chartCanvas").getContext("2d");

    if (chartInstance){
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: type,
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{ticks:{color:"#e5e7eb"},grid:{color:"rgba(148,163,184,0.15)"}},
          y:{ticks:{color:"#e5e7eb"},grid:{color:"rgba(148,163,184,0.15)"}}
        },
        plugins:{
          legend:{labels:{color:"#e5e7eb"}},
          tooltip:{enabled:true}
        }
      }
    });
  }

  function handleStack(){
    if (!dfWork || !dfWork.length){
      showMessage("error","No hay df_work cargado para hacer stack.");
      return;
    }

    const idxSel = document.getElementById("stackIndexCols");
    const orderSel = document.getElementById("stackOrderCols");
    const stackStatus = document.getElementById("stackStatus");

    let log = "";

    // Columnas √≠ndice elegidas en el pop up (multi-select)
    let idxCols = [];
    if (idxSel) {
      idxCols = Array.from(idxSel.selectedOptions).map(o => o.value).filter(c => columns.includes(c));
    }

    if (idxCols.length){
      log += `Columnas √≠ndice v√°lidas: ${idxCols.join(", ")}\n`;
    } else {
      log += `Sin columnas √≠ndice v√°lidas (se ignora √≠ndice).\n`;
    }

    // Crear df2 con columnas idx_1, idx_2, ...
    const df2 = dfWork.map(row => {
      const newRow = {...row};
      idxCols.forEach((c,i)=>{
        newRow[`idx_${i+1}`] = row[c];
      });
      return newRow;
    });

    // Nuevo orden de columnas a partir del pop up (multi-select)
    let newOrder;
    if (orderSel) {
      const desired = Array.from(orderSel.selectedOptions).map(o => o.value).filter(Boolean);
      if (desired.length){
        const validDesired = desired.filter(c => Object.keys(df2[0]).includes(c));
        const extras = Object.keys(df2[0]).filter(c => !validDesired.includes(c));
        newOrder = validDesired.concat(extras);
        log += `Orden solicitado (filtrado a columnas v√°lidas): ${validDesired.join(", ")}\n`;
        if (extras.length){
          log += `Columnas agregadas al final por no estar en el orden seleccionado: ${extras.join(", ")}\n`;
        }
      } else {
        newOrder = Object.keys(df2[0]);
        log += "No se seleccion√≥ un nuevo orden de columnas; se mantiene el orden actual.\n";
      }
    } else {
      newOrder = Object.keys(df2[0]);
      log += "No se encontr√≥ el selector de orden; se mantiene el orden actual.\n";
    }

    dfWork = df2.map(row => {
      const ordered = {};
      newOrder.forEach(c => {
        ordered[c] = row[c];
      });
      return ordered;
    });
    columns = newOrder;

    stackStatus.innerHTML =
      `<div class="alert alert-ok">‚úÖ <b>STACK generado.</b> Dimensiones: <b>${dfWork.length} filas</b> √ó <b>${columns.length} columnas</b></div>` +
      `<div style="margin-top:6px;">Primeras 10 filas del CSV cambiado:</div>` +
      `<div style="margin-top:4px; max-height:260px; overflow:auto;">${dfToHtmlPreview(dfWork,10)}</div>` +
      `\n\n${log}`;

    refreshColumnSelects();
  }

  /* ===================== SPLIT ===================== */
  function doSplit() {
    if (!dfWork || dfWork.length === 0 || columns.length === 0) return;

    const baseCol = document.getElementById("splitBaseCol").value;
    const viewCol = document.getElementById("splitViewCol").value || null;
    const status  = document.getElementById("splitStatus");
    const preview = document.getElementById("splitPreview");

    // Validaci√≥n columna base
    if (!baseCol || !columns.includes(baseCol)) {
      status.innerHTML = `<div class="alert alert-error">‚ùå La columna base '${baseCol}' no existe en df_work.</div>`;
      preview.innerHTML = "";
      return;
    }

    // --- Construir mapa de grupos: valor ‚Üí conteo ---
    const groupsMap = {};
    for (let row of dfWork) {
      const raw = row[baseCol];
      const key = (raw === undefined || raw === null) ? "" : String(raw);
      if (!groupsMap[key]) {
        groupsMap[key] = {
          label: key === "" ? "(vac√≠o)" : key,
          count: 0
        };
      }
      groupsMap[key].count += 1;
    }

    const entries = Object.entries(groupsMap);
    const nGroups = entries.length;

    // Funci√≥n para escapar texto en HTML
    const esc = (s) => String(s)
      .replace(/&/g, "&amp;")
      .replace(/"/g, "&quot;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");

    // --- Render de p√≠ldoras de grupos ---
    let pillsHtml = "";
    for (const [key, g] of entries) {
      const safeKey   = esc(key);
      const safeLabel = esc(g.label);
      pillsHtml += `
        <button class="pill" data-split-value="${safeKey}">
          ${safeLabel} <span style="opacity:.75;">(${g.count})</span>
        </button>
      `;
    }

    status.innerHTML =
      `<div class="alert alert-info">
         ‚ÑπÔ∏è Detectados <b>${nGroups}</b> grupos por '<code>${esc(baseCol)}</code>'.
       </div>` +
      (nGroups > 0
        ? `<div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:4px;">
             ${pillsHtml}
           </div>
           <div style="font-size:0.75rem; color:var(--muted); margin-top:4px;">
             Haz clic en un grupo para filtrar <code>df_work</code> a ese valor.
             Luego puedes usar <b>Exportar CSV</b> o seguir trabajando con el subset.
             Usa <b>Reset Base</b> para volver al CSV original.
           </div>`
        : ""
      );

    // --- Vista previa general (dfWork actual, antes de filtrar) ---
    let colsToShow;
    if (viewCol && columns.includes(viewCol)) {
      colsToShow = [baseCol, viewCol];
    } else {
      colsToShow = columns.slice();
    }

    const dataPreview = dfWork.map(r => {
      const obj = {};
      colsToShow.forEach(c => { obj[c] = r[c]; });
      return obj;
    });

    preview.innerHTML =
      `<div style="margin-top:6px;">Primeras 10 filas ‚Äî tabla completa (antes de filtrar por grupo):</div>` +
      `<div style="margin-top:4px; max-height:260px; overflow:auto;">${dfToHtmlPreview(dataPreview, 10)}</div>`;

    // --- Listeners para las p√≠ldoras (filtrar por grupo) ---
    status.querySelectorAll("button.pill[data-split-value]").forEach(btn => {
      btn.addEventListener("click", () => {
        const valKey = btn.getAttribute("data-split-value");

        const filtered = dfWork.filter(row => {
          const raw = row[baseCol];
          const k = (raw === undefined || raw === null) ? "" : String(raw);
          return k === valKey;
        });

        if (!filtered.length) {
          showMessage("error", `No se encontraron filas para el grupo seleccionado.`);
          return;
        }

        // Actualizar dfWork y columnas con el grupo elegido
        dfWork   = filtered;
        columns  = dfWork.length ? Object.keys(dfWork[0]) : [];

        showMessage(
          "info",
          `‚úÖ df_work filtrado por <code>${esc(baseCol)}</code> = <code>${esc(valKey || "(vac√≠o)")}</code>. Filas: <b>${dfWork.length}</b>.`
        );

        // Refrescar todos los selects / tarjetas
        refreshColumnSelects();

        // Vista previa del grupo seleccionado
        let colsToShow2;
        if (viewCol && columns.includes(viewCol)) {
          colsToShow2 = [baseCol, viewCol];
        } else {
          colsToShow2 = columns.slice();
        }
        const dataPreviewFiltered = dfWork.map(r => {
          const obj = {};
          colsToShow2.forEach(c => { obj[c] = r[c]; });
          return obj;
        });

        preview.innerHTML =
          `<div style="margin-top:6px;">Primeras 10 filas del grupo seleccionado:</div>` +
          `<div style="margin-top:4px; max-height:260px; overflow:auto;">${dfToHtmlPreview(dataPreviewFiltered, 10)}</div>`;
      });
    });
  }
  /* ===================== EXPORT / RESET ===================== */

  function renderDfPreview() {
    const dfPreview = document.getElementById("dfPreview");
    if (!dfWork || dfWork.length===0) {
      dfPreview.innerHTML = "<em>(df_work vac√≠o)</em>";
      document.getElementById("exportStatus").textContent = "df_work actual: (vac√≠o)";
      return;
    }
    dfPreview.innerHTML = dfToHtmlPreview(dfWork, 15);
    document.getElementById("exportStatus").textContent =
      `df_work actual: ${dfWork.length} filas √ó ${columns.length} columnas.`;
  }

  function handleExportCsv(){
    if (!dfWork || !dfWork.length){
      showMessage("error","No hay df_work para exportar.");
      return;
    }
    const header = Object.keys(dfWork[0]);
    const rows = dfWork.map(r => header.map(c => r[c]));
    const csvLines = [];
    csvLines.push(header.map(c => `"${String(c).replace(/"/g,'""')}"`).join(","));
    rows.forEach(row => {
      const line = row.map(v => {
        if (v===null || v===undefined) return "";
        const s = String(v).replace(/"/g,'""');
        return `"${s}"`;
      }).join(",");
      csvLines.push(line);
    });
    const blob = new Blob([csvLines.join("\n")], {type: "text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "df_work.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showMessage("ok","Archivo <b>df_work.csv</b> descargado.");
  }

  function handleReset(){
    dfWork = [];
    columns = [];
    originalDf = [];
    const ids = ["statsCol","chartX","chartY","stackIndexCols","stackOrderCols","splitBaseCol","splitViewCol"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el && el.tagName==="SELECT"){
        while (el.firstChild) el.removeChild(el.firstChild);
      }
    });
    document.getElementById("columnsList").textContent = "(vac√≠o)";
    document.getElementById("statsResult").textContent = "";
    document.getElementById("stackStatus").textContent = "";
    document.getElementById("splitStatus").textContent = "";
    document.getElementById("splitPreview").textContent = "";
    if (chartInstance){
      chartInstance.destroy();
      chartInstance = null;
    }
    document.getElementById("chartCanvas").getContext("2d").clearRect(0,0,3000,3000);
    renderDfPreview();
    document.getElementById("loadStatus").textContent = "A√∫n no se ha cargado ning√∫n CSV.";
    document.getElementById("exportStatus").textContent = "df_work actual: (vac√≠o)";
  }

  // Eventos
  document.getElementById("btnLoadCsv").addEventListener("click", handleLoadCsv);
  document.getElementById("btnStats").addEventListener("click", renderStats);
  document.getElementById("btnChart").addEventListener("click", renderChart);
  document.getElementById("btnStack").addEventListener("click", handleStack);
  document.getElementById("btnSplit").addEventListener("click", doSplit);
  document.getElementById("btnExportCsv").addEventListener("click", handleExportCsv);
  document.getElementById("btnReset").addEventListener("click", handleReset);
</script>
</body>
</html>
